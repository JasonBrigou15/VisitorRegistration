@page "/admin/employees"
@using VisitorRegistrationShared.Dtos.Company
@using VisitorRegistrationShared.Dtos.Employee
@using VisitorRegistrationUI.Services
@inject VisitorRegistrationUI.Services.AdminService AdminService
@inject EmployeeService employeeService
@inject CompanyService companyService
@inject NavigationManager Nav

<div class="flex-container">
    <h2>Werknemers Beheren</h2>

    @if (employees == null)
    {
        <p>Laden...</p>
    }
    else
    {
        <div style="border-radius: 15px;
                            border: 2px solid black;
                            padding: 40px;
                            background-color: white;
                            max-width: 1400px;
                            width: 100%;">

            <FluentButton Appearance="Appearance.Accent" OnClick="ShowAddDialog">Nieuwe Werknemer</FluentButton>

            <FluentDataGrid Items="@employees.AsQueryable()" style="margin-top: 20px;">
                <PropertyColumn Property="@(e => e.EmployeeId)" Title="ID" Class="bordered-column" />
                <PropertyColumn Property="@(e => e.FirstName)" Title="Voornaam" Class="bordered-column" />
                <PropertyColumn Property="@(e => e.LastName)" Title="Achternaam" Class="bordered-column" />
                <PropertyColumn Property="@(e => e.Title)" Title="Functie" Class="bordered-column" />
                <PropertyColumn Property="@(e => e.CompanyName)" Title="Bedrijf" Class="bordered-column" />
                <TemplateColumn Title="Acties" Class="bordered-column" Style="min-width: 200px;">
                    <FluentButton Appearance="Appearance.Accent" OnClick="@(() => EditEmployee(context))">Bewerken</FluentButton>
                    <FluentButton BackgroundColor="red" Color="white" OnClick="@(() => DeleteEmployee(context.EmployeeId))">Verwijderen</FluentButton>
                </TemplateColumn>
            </FluentDataGrid>
        </div>
    }

    <FluentDialog @bind-Hidden="dialogHidden" Style="text-align: center;">
        <FluentDialogHeader>
            <h3>@dialogTitle</h3>
        </FluentDialogHeader>

        <EditForm Model="@currentEmployee" OnValidSubmit="SaveEmployee">
            <DataAnnotationsValidator />

            <FluentTextField @bind-Value="currentEmployee.FirstName"
                             Label="Voornaam"
                             Required="true"
                             Style="width: 100%; margin-bottom: 10px;" />

            <FluentTextField @bind-Value="currentEmployee.LastName"
                             Label="Achternaam"
                             Required="true"
                             Style="width: 100%; margin-bottom: 10px;" />

            <FluentTextField @bind-Value="currentEmployee.Title"
                             Label="Functie"
                             Required="true"
                             Style="width: 100%; margin-bottom: 10px;" />

            <FluentSelect TOption="string"
                          @bind-Value="selectedCompanyId"
                          Label="Bedrijf"
                          Style="width: 100%; margin-bottom: 10px; border: 2px solid black">
                <FluentOption Value="0">-- Selecteer een bedrijf --</FluentOption>

                @foreach (var company in companies)
                {
                    <FluentOption Value="@company.CompanyId.ToString()">@company.CompanyName</FluentOption>
                }

            </FluentSelect>

            <ValidationSummary />

            <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent">Opslaan</FluentButton>
            <FluentButton BackgroundColor="red" Color="white" OnClick="CloseDialog">Annuleren</FluentButton>
        </EditForm>
    </FluentDialog>

    <FluentDialog @bind-Hidden="deleteDialogHidden" Style="text-align: center;">
        <h3>Weet je het zeker?</h3>
        <p>Wil je deze werknemer verwijderen?</p>

        <FluentButton BackgroundColor="red" Color="white" OnClick="ConfirmDelete">Ja, verwijderen</FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="CancelDelete">Annuleren</FluentButton>
    </FluentDialog>
</div>

@code {
    private List<GetEmployeeDto> employees = new();
    private List<GetCompanyDto> companies = new();
    private bool dialogHidden = true;
    private bool deleteDialogHidden = true;
    private string dialogTitle = "";
    private CreateEmployeeDto currentEmployee = new() { FirstName = "", LastName = "", Title = "", CompanyId = 0 };
    private string selectedCompanyId = "0";
    private bool isEditMode = false;
    private int editEmployeeId = 0;
    private int deleteEmployeeId = 0;

    protected override async Task OnInitializedAsync()
    {
        await AdminService.CheckSession();
        if (!AdminService.IsAdminLoggedIn)
        {
            Nav.NavigateTo("/");
        }

        await LoadEmployees();
        await LoadCompanies();
    }

    private async Task LoadEmployees()
    {
        employees = await employeeService.GetEmployees();
    }

    private async Task LoadCompanies()
    {
        companies = await companyService.GetCompanies();
    }

    private void ShowAddDialog()
    {
        dialogTitle = "Nieuwe Werknemer Toevoegen";
        isEditMode = false;
        currentEmployee = new() { FirstName = "", LastName = "", Title = "", CompanyId = 0 };
        selectedCompanyId = "0";
        dialogHidden = false;
    }

    private void EditEmployee(GetEmployeeDto employee)
    {
        dialogTitle = "Werknemer Bewerken";
        isEditMode = true;
        editEmployeeId = employee.EmployeeId;
        currentEmployee = new()
        {
            FirstName = employee.FirstName,
            LastName = employee.LastName,
            Title = employee.Title,
            CompanyEmail = employee.CompanyEmail
        };
        selectedCompanyId = employee.CompanyId.ToString();
        currentEmployee.CompanyId = employee.CompanyId;
        dialogHidden = false;
    }

    private async Task SaveEmployee()
    {
        try
        {
            currentEmployee.CompanyId = int.Parse(selectedCompanyId);

            if (isEditMode)
            {
                var company = companies.FirstOrDefault(c => c.CompanyId == currentEmployee.CompanyId);

                var updateDto = new UpdateEmployeeDto
                {
                    Id = editEmployeeId,
                    FirstName = currentEmployee.FirstName,
                    LastName = currentEmployee.LastName,
                    Title = currentEmployee.Title,
                    CompanyId = currentEmployee.CompanyId,
                    CompanyEmail = VisitorRegistrationShared.Extensions.StringExtensions.ToEmailAddress(
                    currentEmployee.FirstName,
                    currentEmployee.LastName,
                    currentEmployee.Title,
                    company?.CompanyName ?? ""
                    )
                };
                await employeeService.UpdateEmployee(updateDto);
            }
            else
            {
                await employeeService.CreateEmployee(currentEmployee);
            }

            dialogHidden = true;
            await LoadEmployees();
        }
        catch (Exception)
        {
            dialogHidden = true;
        }
    }

    private void DeleteEmployee(int id)
    {
        deleteEmployeeId = id;
        deleteDialogHidden = false;
    }

    private async Task ConfirmDelete()
    {
        try
        {
            await employeeService.DeleteEmployee(deleteEmployeeId);
            deleteDialogHidden = true;
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private void CancelDelete()
    {
        deleteDialogHidden = true;
    }

    private void CloseDialog()
    {
        dialogHidden = true;
    }
}